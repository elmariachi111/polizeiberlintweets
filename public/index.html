<html>

<head>

    <title>Polizeibericht</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?libraries=geometry,visualization&key=AIzaSyCuXcmuT62c-y94gRJxeRkC7MBQsWLLUvU">
    </script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/handlebars/handlebars.min.js"></script>
    <script src="bower_components/moment/min/moment.min.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/backbone/backbone.js"></script>
    <script src="javascripts/intents.js"></script>
    <script src="javascripts/MapEx.js"></script>
    <script src="javascripts/Infobox.js"></script>
    <link rel="stylesheet" href="stylesheets/main.css" />

</head>
<body>
<div id="map-canvas">

</div>
<div id="overlay">
    <div class="content">

    </div>
</div>

<script>

    Handlebars.registerHelper('datefmt', function(date) {
        var m = moment(date);
        return m.format("DD.MM.YY HH:mm");
    });
    Handlebars.registerHelper('tweettxt', function(tweet) {

        var  txt = tweet.text;
        var res = "";
        var hts = tweet.entities.hashtags;
        if (hts.length > 0 ) {
            var cur = 0;
            _.forEach(hts, function(ht) {
                res += txt.substr(cur, ht.indices[0]-cur);
                var lnk = 'https://twitter.com/hashtag/'+ht.text+'?src=hash';
                res += ' <a href="'+lnk+'" target="_blank">'+'#'+ht.text+'</a> ';
                cur = ht.indices[1];
            });
            res += txt.substr(cur);
        } else {
            res = tweet.text;
        }
        return res;
    });


    $( function() {
        window.TweetView.prototype.tpl = Handlebars.compile($('#tpl-tweet').html());

        var map = new Map({ el: document.getElementById("map-canvas") });

        var infoBox = new Infobox({el: document.getElementById("overlay")});
        infoBox.listenTo(map,"hover:district", infoBox.hintDistrict);
        infoBox.listenTo(map,"selected:district", infoBox.showDistrict);
        map.listenTo(infoBox,"marker:set", map.setMarker);
        map.listenTo(infoBox,"marker:unset", map.unsetMarker);
        google.maps.event.addDomListener(window, 'load', map.prepareMap.bind(map));

    })
</script>
<script id="tpl-tweet" type="text/x-handlebars-template">
    <div class="user">
        <a href="https://twitter.com/{{user.screen_name}}" target="_blank"><img class="user" src="{{user.profile_image_url}}" width="50" /></a>
        <h3><a href="https://twitter.com/{{user.screen_name}}" target="_blank">{{user.name}}</a></h3>
        <small><a href="https://twitter.com/{{user.screen_name}}" target="_blank">@{{user.screen_name}}</a></small>
    </div>
    <p class="text">{{{tweettxt . }}}</p>
    <div class="date"> <a href="https://twitter.com/{{user.screen_name}}/status/{{id_str}}" target="_blank">{{datefmt created}}</a> </div>
    <div class="actions">
        <p><a href="https://twitter.com/intent/tweet?in_reply_to={{id_str}}"><i class="glyph reply"> </i>Antworten</a></p>
        <p><a href="https://twitter.com/intent/retweet?tweet_id={{id_str}}"><i class="glyph retweet"> </i>Retweeten</a></p>
        <p><a href="https://twitter.com/intent/favorite?tweet_id={{id_str}}"><i class="glyph favorite"> </i>Favorisieren</a></p>

    </div>
</script>

</body>
</html>